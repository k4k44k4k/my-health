<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Health Concierge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto+Sans+JP', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 700; }
        input[type="range"] { accent-color: #3b82f6; }
        .calendar-day { min-height: 80px; }
        .today { background-color: #eff6ff; border: 2px solid #3b82f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .risk-pill { padding: 2px 8px; border-radius: 9999px; font-size: 10px; font-weight: bold; }
        .risk-high { background-color: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .risk-mid { background-color: #ffedd5; color: #f59e0b; border: 1px solid #fdba74; }
        .risk-low { background-color: #ecfdf5; color: #10b981; border: 1px solid #6ee7b7; }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <!-- App Container -->
    <div id="app" class="max-w-5xl mx-auto p-4 pb-24 lg:p-8">
        
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Health Pro <span class="text-blue-600">AI</span></h1>
                <div class="flex items-center gap-3 mt-2 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
                    <i data-lucide="calendar" class="w-4 h-4 text-blue-500"></i>
                    <input type="date" id="active-date-picker" onchange="handleDateChange(this.value)" class="text-sm border-none bg-transparent font-bold text-slate-700 outline-none cursor-pointer">
                </div>
            </div>
            
            <div id="profile-summary" class="flex items-center gap-4 bg-white p-4 rounded-2xl shadow-md border border-slate-100 min-w-[280px]">
                <div class="relative">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg">
                        <i data-lucide="user"></i>
                    </div>
                    <div id="health-indicator" class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-white rounded-full"></div>
                </div>
                <div>
                    <p id="header-user-name" class="text-base font-bold text-slate-900 leading-none">ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼</p>
                    <div class="flex items-center gap-2 mt-1.5">
                        <span id="header-bmi" class="text-[10px] font-bold px-2 py-0.5 bg-slate-100 rounded text-slate-500 tracking-wider">BMI: --</span>
                        <span id="header-scan-status" class="text-[10px] font-bold px-2 py-0.5 bg-blue-50 rounded text-blue-600 tracking-wider uppercase">æœªè§£æ</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Navigation -->
        <nav class="flex overflow-x-auto space-x-8 border-b border-slate-200 mb-8 no-scrollbar sticky top-0 bg-slate-50/80 backdrop-blur-md z-40 py-2">
            <button onclick="switchTab('input')" id="tab-input" class="pb-3 px-1 text-sm font-semibold whitespace-nowrap transition-all tab-active">æ—¥å¸¸ãƒ­ã‚°</button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="pb-3 px-1 text-sm font-semibold whitespace-nowrap transition-all text-slate-400">AIæ·±å±¤è§£æ</button>
            <button onclick="switchTab('history')" id="tab-history" class="pb-3 px-1 text-sm font-semibold whitespace-nowrap transition-all text-slate-400">ãƒ‡ãƒ¼ã‚¿å±¥æ­´</button>
            <button onclick="switchTab('recipes')" id="tab-recipes" class="pb-3 px-1 text-sm font-semibold whitespace-nowrap transition-all text-slate-400">å¥åº·ãƒ¬ã‚·ãƒ”</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="pb-3 px-1 text-sm font-semibold whitespace-nowrap transition-all text-slate-400">è¨ºæ–­æ›¸ã‚¹ã‚­ãƒ£ãƒ³</button>
        </nav>

        <!-- View: Daily Input -->
        <section id="view-input" class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Water -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500">
                                <i data-lucide="droplets"></i>
                            </div>
                            <h3 class="font-bold text-slate-800">æ°´åˆ†è£œçµ¦</h3>
                        </div>
                        <span id="water-val" class="text-2xl font-black text-blue-600">0 <span class="text-xs text-slate-400">ml</span></span>
                    </div>
                    <input type="range" id="input-water" min="0" max="3000" step="100" value="0" oninput="updateWaterLabel(this.value)" class="w-full h-2.5 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between mt-3 text-[10px] font-bold text-slate-400">
                        <span>0ml</span>
                        <span>1500ml</span>
                        <span>3000ml</span>
                    </div>
                </div>

                <!-- Vital Stats -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">ä½“é‡ (kg)</label>
                        <input type="number" id="input-weight" step="0.1" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-xl font-black focus:ring-2 focus:ring-blue-100 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">è¡€åœ§ (Sys/Dia)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="input-bp-high" placeholder="120" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-xl font-black focus:ring-2 focus:ring-blue-100 outline-none transition-all">
                            <span class="text-slate-300 font-bold">/</span>
                            <input type="number" id="input-bp-low" placeholder="80" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-xl font-black focus:ring-2 focus:ring-blue-100 outline-none transition-all">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meals Section -->
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 flex items-center gap-3">
                        <i data-lucide="utensils" class="text-orange-500"></i>
                        ä»Šæ—¥ã®é£Ÿäº‹å†…å®¹
                    </h3>
                    <button onclick="openRecipePicker()" class="px-4 py-2 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-bold text-blue-600 transition-colors flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> ãƒ¬ã‚·ãƒ”ã‹ã‚‰è¿½åŠ 
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">æœé£Ÿ</span>
                            <input type="text" id="meal-morning" placeholder="åµ, ç´è±†, ã”é£¯..." class="w-full mt-1.5 p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:bg-white transition-all outline-none">
                        </div>
                        <div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">æ˜¼é£Ÿ</span>
                            <input type="text" id="meal-lunch" placeholder="ã‚µãƒ©ãƒ€, ãƒ‘ã‚¹ã‚¿..." class="w-full mt-1.5 p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:bg-white transition-all outline-none">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å¤•é£Ÿ</span>
                            <input type="text" id="meal-dinner" placeholder="ç„¼ãé­š, å‘³å™Œæ±..." class="w-full mt-1.5 p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:bg-white transition-all outline-none">
                        </div>
                        <div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">é–“é£Ÿãƒ»é£²é…’</span>
                            <input type="text" id="meal-snack" placeholder="ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ, ãƒ“ãƒ¼ãƒ«..." class="w-full mt-1.5 p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:bg-white transition-all outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lifestyle Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Rhythm -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 flex items-center gap-3 mb-6">
                        <i data-lucide="clock" class="text-purple-500"></i> ç¡çœ ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ 
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">èµ·åºŠæ™‚é–“</label>
                            <input type="time" id="input-wake" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">å°±å¯æ™‚é–“</label>
                            <input type="time" id="input-sleep" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none">
                        </div>
                    </div>
                </div>
                <!-- Activities -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 flex items-center gap-3 mb-6">
                        <i data-lucide="activity" class="text-green-500"></i> æ´»å‹•ãƒ»ãƒ¡ãƒ¢
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">é‹å‹•ãƒ»æ­©æ•°</label>
                            <input type="text" id="input-exercise" placeholder="ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚° 30åˆ†ãªã©" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">ä½“èª¿ãƒ»å‚™è€ƒ</label>
                            <input type="text" id="input-stool" placeholder="ä½“èª¿ã®å¤‰åŒ–ã‚„æ’ä¾¿ãªã©" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="saveDailyData()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold shadow-xl hover:bg-blue-600 transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                <i data-lucide="save" class="w-5 h-5"></i> ãƒ­ã‚°ã‚’å®‰å…¨ã«ä¿å­˜
            </button>
        </section>

        <!-- View: Deep Analysis -->
        <section id="view-analysis" class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Top Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-slate-800">æ „é¤Šãƒãƒ©ãƒ³ã‚¹åˆ†æ</h3>
                        <div id="analysis-date-label" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold">LATEST RECORD</div>
                    </div>
                    <div class="max-w-[320px] mx-auto py-4">
                        <canvas id="nutrientChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-sm mb-6 text-slate-400 tracking-widest uppercase">å¥åº·ãƒªã‚¹ã‚¯åˆ¤å®š</h3>
                    <div id="health-risk-list" class="space-y-6">
                        <!-- Risk items will be injected -->
                    </div>
                </div>
            </div>

            <!-- Findings Box -->
            <div id="findings-section" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 hidden">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i data-lucide="clipboard-list" class="text-indigo-500"></i>
                    æ¤œå‡ºã•ã‚ŒãŸå¥åº·è¨ºæ–­ã®æ‰€è¦‹
                </h3>
                <div id="findings-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Dynamic Findings -->
                </div>
            </div>
            
            <!-- AI Comprehensive Report -->
            <div class="bg-gradient-to-br from-slate-900 to-indigo-950 p-8 rounded-[40px] text-white shadow-2xl relative overflow-hidden">
                <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl"></div>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-white/10 backdrop-blur-md rounded-xl flex items-center justify-center">
                        <i data-lucide="brain" class="text-blue-400"></i>
                    </div>
                    <h3 class="text-xl font-bold">AIç·åˆãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                </div>
                <div id="ai-report-content" class="space-y-6 text-slate-300 text-sm leading-relaxed">
                    <!-- AI Report Content -->
                </div>
            </div>

            <!-- Food Suggestions -->
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-6 text-xs text-slate-400 uppercase tracking-widest">è§£æçµæœã«åŸºã¥ãæ¨å¥¨é£Ÿæ</h3>
                <div id="suggested-foods" class="flex flex-wrap gap-3"></div>
            </div>
        </section>

        <!-- View: History Search -->
        <section id="view-history" class="hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-8">
                    <h3 id="calendar-title" class="text-xl font-black text-slate-800">2024.05</h3>
                    <div class="flex gap-2">
                        <button onclick="prevMonth()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i data-lucide="chevron-left"></i></button>
                        <button onclick="nextMonth()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-[10px] font-black text-slate-300 mb-4 uppercase tracking-tighter">
                    <span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-3 p-3 bg-slate-50 border border-slate-100 rounded-2xl mb-6">
                    <i data-lucide="search" class="text-slate-400 w-5 h-5 ml-2"></i>
                    <input type="text" id="history-search" oninput="searchHistory(this.value)" placeholder="éå»ã®é£Ÿäº‹å†…å®¹ã‚„ãƒ¡ãƒ¢ã‚’æ¤œç´¢..." class="w-full text-sm bg-transparent outline-none p-2 font-medium">
                </div>
                <div id="search-results" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>
        </section>

        <!-- View: Scanner (Settings) -->
        <section id="view-settings" class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white p-10 rounded-[40px] shadow-sm border border-slate-100">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center">
                        <i data-lucide="scan"></i>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-xl">å¥åº·è¨ºæ–­æ›¸ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ»ã‚¹ã‚­ãƒ£ãƒ³</h3>
                        <p class="text-sm text-slate-500 mt-1">AIãŒæ•°å€¤ã ã‘ã§ãªãã€åˆ¤å®šåŒºåˆ†ã‚„åŒ»å¸«ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚‚èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
                    </div>
                </div>
                
                <textarea id="checkup-text-input" placeholder="è¨ºæ–­çµæœã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
ä¾‹:
åˆ¤å®š: è‚æ©Ÿèƒ½(C), è¡€åœ§(B)
æ‰€è¦‹: è»½åº¦ã®è„‚è‚ªè‚ã®ç–‘ã„ãŒã‚ã‚Šã¾ã™ã€‚è¡€åœ§ãŒå¢ƒç•ŒåŸŸã§ã™ã€‚
LDLã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ« 158 mg/dL, AST 45, ALT 52..." 
                class="w-full p-6 bg-slate-50 border border-slate-100 rounded-3xl text-sm h-64 mb-6 outline-none focus:ring-4 focus:ring-blue-100 focus:bg-white transition-all leading-relaxed"></textarea>
                
                <button onclick="analyzeCheckupText()" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-extrabold shadow-xl hover:bg-blue-700 transition-all flex items-center justify-center gap-3">
                    <i data-lucide="zap"></i> AIæ·±å±¤ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
                </button>
                
                <div id="checkup-summary-details" class="mt-10 hidden border-t border-slate-100 pt-8">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-6 tracking-widest">è§£æã•ã‚ŒãŸãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ãƒ»ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h4>
                    <div id="param-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <!-- Parameter cards -->
                    </div>
                </div>
            </div>

            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-6 border-b pb-4 text-slate-800">åŸºæœ¬ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">ãŠåå‰</label>
                        <input type="text" id="setting-name" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">èº«é•· (cm)</label>
                        <input type="number" id="setting-height" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold">
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold shadow-xl">åŸºæœ¬è¨­å®šã‚’æ›´æ–°</button>
        </section>

        <!-- View: Recipes (Minimal implementation) -->
        <section id="view-recipes" class="hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-6 text-slate-800">ãƒã‚¤ãƒ¬ã‚·ãƒ”ç™»éŒ²</h3>
                <div class="space-y-4">
                    <input type="text" id="recipe-name" placeholder="ä¾‹: ãƒ˜ãƒ«ã‚·ãƒ¼æµ·é®®ä¸¼" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm">
                    <textarea id="recipe-items" placeholder="å…·æã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: ã¾ãã‚, ã‚µãƒ¼ãƒ¢ãƒ³, ç„ç±³ï¼‰" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm h-24"></textarea>
                    <button onclick="saveRecipe()" class="w-full bg-blue-600 text-white py-3 rounded-2xl font-bold">ãƒã‚¤ãƒ¬ã‚·ãƒ”ã«è¿½åŠ </button>
                </div>
            </div>
            <div id="recipe-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </section>

    </div>

    <!-- Modals -->
    <div id="recipe-picker-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-50 backdrop-blur-md transition-all">
        <div class="bg-white rounded-[40px] p-10 w-full max-w-lg shadow-2xl animate-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center mb-8">
                <h3 class="font-extrabold text-2xl text-slate-900 tracking-tight">ãƒ¬ã‚·ãƒ”ã®å‘¼ã³å‡ºã—</h3>
                <button onclick="closeRecipePicker()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x"></i></button>
            </div>
            <div id="picker-list" class="space-y-4 max-h-[50vh] overflow-y-auto pr-3 no-scrollbar"></div>
        </div>
    </div>

    <!-- Alert Toast -->
    <div id="msg-box" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-4 rounded-full shadow-2xl text-sm font-bold hidden z-50 animate-in slide-in-from-bottom-10"></div>

    <script>
        // --- Medical Constants & Intelligence Base ---
        const MED_REF = {
            standards: {
                bmi: { normal: [18.5, 25], source: "æ—¥æœ¬è‚¥æº€å­¦ä¼š" },
                bpHigh: { normal: 135, danger: 140, source: "æ—¥æœ¬é«˜è¡€åœ§å­¦ä¼š" },
                bpLow: { normal: 85, danger: 90, source: "æ—¥æœ¬é«˜è¡€åœ§å­¦ä¼š" },
                glucose: { normal: 100, danger: 126, source: "æ—¥æœ¬ç³–å°¿ç—…å­¦ä¼š" },
                hba1c: { normal: 5.6, danger: 6.5, source: "æ—¥æœ¬ç³–å°¿ç—…å­¦ä¼š" },
                ldl: { normal: 120, danger: 140, source: "æ—¥æœ¬å‹•è„ˆç¡¬åŒ–å­¦ä¼š" },
                ast: { normal: 30, danger: 40, source: "æ—¥æœ¬äººé–“ãƒ‰ãƒƒã‚¯å­¦ä¼š" },
                alt: { normal: 30, danger: 40, source: "æ—¥æœ¬äººé–“ãƒ‰ãƒƒã‚¯å­¦ä¼š" },
                gtp: { normal: 50, danger: 50, source: "æ—¥æœ¬äººé–“ãƒ‰ãƒƒã‚¯å­¦ä¼š" }
            },
            keywords: [
                { id: 'fatty_liver', words: ['è„‚è‚ªè‚', 'è‚è„‚è‚ª'], severity: 'mid', advice: 'è„‚è³ªã¨ç³–è³ªã®æ‘‚å–ã‚’æ§ãˆã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚’æ¸›ã‚‰ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚', basis: 'è‚è‡“ã¸ã®è„‚è‚ªè“„ç©ãŒæŒ‡æ‘˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»£è¬ç•°å¸¸ã®äºˆå…†ã§ã™ã€‚' },
                { id: 'hypertension', words: ['é«˜è¡€åœ§', 'è¡€åœ§é«˜ã‚', 'è¡€åœ§(B)', 'è¡€åœ§(C)'], severity: 'high', advice: 'æ¸›å¡©(1æ—¥6gæœªæº€)ã¨é©åº¦ãªæœ‰é…¸ç´ é‹å‹•ãŒæ€¥å‹™ã§ã™ã€‚', basis: 'è¡€ç®¡ã¸ã®æŒç¶šçš„ãªè² è·ãŒæŒ‡æ‘˜ã•ã‚Œã¦ã„ã¾ã™ã€‚å‹•è„ˆç¡¬åŒ–ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚' },
                { id: 'dyslipidemia', words: ['è„‚è³ªç•°å¸¸', 'ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«é«˜ã‚', 'é«˜è„‚è¡€ç—‡'], severity: 'mid', advice: 'é’é­š(EPA/DHA)ã‚’å¢—ã‚„ã—ã€é£½å’Œè„‚è‚ªé…¸(è‚‰ã®è„‚)ã‚’æ¸›ã‚‰ã—ã¾ã—ã‚‡ã†ã€‚', basis: 'è¡€æ¶²ä¸­ã®è„‚è³ªãƒãƒ©ãƒ³ã‚¹ãŒå´©ã‚Œã¦ã„ã¾ã™ã€‚å¿ƒç–¾æ‚£ãƒªã‚¹ã‚¯ã‚’é«˜ã‚ã¾ã™ã€‚' },
                { id: 'gastritis', words: ['é€†æµæ€§é£Ÿé“ç‚', 'èƒƒç‚', 'èƒƒéƒ¨ä¸å¿«'], severity: 'low', advice: 'å°±å¯3æ™‚é–“å‰ã®é£Ÿäº‹ã‚’é¿ã‘ã€è…¹å…«åˆ†ç›®ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚', basis: 'æ¶ˆåŒ–å™¨ç²˜è†œã¸ã®è² è·ãŒæ‡¸å¿µã•ã‚Œã¾ã™ã€‚' },
                { id: 'diabetes', words: ['è¡€ç³–é«˜ã‚', 'ç³–å°¿ç—…', 'è€ç³–èƒ½ç•°å¸¸'], severity: 'high', advice: 'ãƒ™ã‚¸ã‚¿ãƒ–ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚’å¾¹åº•ã—ã€ç²¾è£½ç³–ï¼ˆç™½ã„ãƒ‘ãƒ³ã‚„ç ‚ç³–ï¼‰ã‚’é¿ã‘ã¾ã—ã‚‡ã†ã€‚', basis: 'ã‚¤ãƒ³ã‚¹ãƒªãƒ³æŠµæŠ—æ€§ã®ä½ä¸‹ãŒç–‘ã‚ã‚Œã¾ã™ã€‚' },
                { id: 're-exam', words: ['å†æ¤œæŸ»', 'ç²¾å¯†æ¤œæŸ»', 'è¦æ²»ç™‚'], severity: 'high', advice: 'é€Ÿã‚„ã‹ã«åŒ»ç™‚æ©Ÿé–¢ã‚’å—è¨ºã—ã€è©³ç´°ãªæ¤œæŸ»ã‚’å—ã‘ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚', basis: 'è¨ºæ–­é …ç›®ã«ãŠã„ã¦è‡¨åºŠçš„ã«é‡è¦ãªç•°å¸¸ãŒèªã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚' }
            ]
        };

        const FOOD_KNOWLEDGE = {
            "åµ": { p: 8, c: 1, f: 6, v: 5, fi: 0, s: 0.1 },
            "ã”é£¯": { p: 2, c: 9, f: 0, v: 1, fi: 2, s: 0 },
            "ç„ç±³": { p: 3, c: 8, f: 1, v: 4, fi: 5, s: 0 },
            "é¶": { p: 10, c: 0, f: 3, v: 2, fi: 0, s: 0.2 },
            "ã‚µãƒ": { p: 9, c: 0, f: 8, v: 4, fi: 0, s: 0.5 },
            "é‡èœ": { p: 1, c: 2, f: 0, v: 10, fi: 9, s: 0 },
            "ç´è±†": { p: 7, c: 3, f: 4, v: 6, fi: 6, s: 0.4 },
            "å‘³å™Œæ±": { p: 2, c: 3, f: 1, v: 3, fi: 2, s: 1.8 },
            "ãƒ©ãƒ¼ãƒ¡ãƒ³": { p: 4, c: 10, f: 8, v: 1, fi: 1, s: 6.5 },
            "ãƒ“ãƒ¼ãƒ«": { p: 0, c: 4, f: 0, v: 0, fi: 0, s: 0 }
        };

        // --- State Management ---
        let state = {
            profile: JSON.parse(localStorage.getItem('ai_health_v4_prof')) || { 
                name: 'ã‚²ã‚¹ãƒˆ', height: 170, routineEx: '', routineMeal: '',
                checkup: { params: {}, findings: [] } 
            },
            dailyData: JSON.parse(localStorage.getItem('ai_health_v4_data')) || {},
            recipes: JSON.parse(localStorage.getItem('ai_health_v4_recipes')) || [],
            currentDate: new Date().toISOString().split('T')[0],
            calendarViewDate: new Date(),
            chart: null
        };

        window.onload = () => {
            lucide.createIcons();
            const datePicker = document.getElementById('active-date-picker');
            if (datePicker) datePicker.value = state.currentDate;
            
            loadProfileUI();
            initCurrentDay(state.currentDate);
            initChart();
            updateHistoryUI();
            updateRecipeUI();
            renderScanResults();
        };

        // --- Scanner Logic ---
        function analyzeCheckupText() {
            const text = document.getElementById('checkup-text-input').value;
            if (!text) return;

            const results = { params: {}, findings: [] };
            
            // 1. Numerical Analysis (Refined Regex)
            const getVal = (reg) => { const m = text.match(reg); return m ? parseFloat(m[1]) : null; };
            results.params = {
                weight: getVal(/(?:ä½“é‡|BW)\s*[:ï¼š]?\s*(\d+(?:\.\d+)?)/i),
                bpHigh: getVal(/(?:æœ€é«˜è¡€åœ§|åç¸®æœŸ|SBP)\s*[:ï¼š]?\s*(\d+)/i) || getVal(/(\d+)\/\d+/),
                bpLow: getVal(/(?:æœ€ä½è¡€åœ§|æ‹¡å¼µæœŸ|DBP)\s*[:ï¼š]?\s*(\d+)/i) || getVal(/\d+\/(\d+)/),
                ast: getVal(/(?:AST|GOT)\s*[:ï¼š]?\s*(\d+)/i),
                alt: getVal(/(?:ALT|GPT)\s*[:ï¼š]?\s*(\d+)/i),
                gtp: getVal(/(?:Î³-GTP|GTP)\s*[:ï¼š]?\s*(\d+)/i),
                ldl: getVal(/(?:LDL|æ‚ªç‰)\s*[:ï¼š]?\s*(\d+)/i),
                hba1c: getVal(/(?:HbA1c)\s*[:ï¼š]?\s*(\d+(?:\.\d+)?)/i)
            };

            // 2. Keyword/Sentiment Analysis (Foundings)
            MED_REF.keywords.forEach(k => {
                if (k.words.some(w => text.includes(w))) {
                    results.findings.push(k);
                }
            });

            // Merge & Save
            Object.keys(results.params).forEach(p => {
                if (results.params[p] !== null) state.profile.checkup.params[p] = results.params[p];
            });
            state.profile.checkup.findings = results.findings;

            saveSettings(false);
            renderScanResults();
            showMessage('è¨ºæ–­æ›¸ã‚’ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ»ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã—ãŸ');
            switchTab('analysis');
        }

        function renderScanResults() {
            const grid = document.getElementById('param-grid');
            const summary = document.getElementById('checkup-summary-details');
            if (!grid || !summary) return;

            const check = state.profile.checkup;
            if (Object.keys(check.params).length === 0 && check.findings.length === 0) return;
            
            summary.classList.remove('hidden');
            grid.innerHTML = '';

            Object.entries(check.params).forEach(([key, val]) => {
                const std = MED_REF.standards[key];
                let status = "NORMAL";
                let col = "text-emerald-500";
                
                if (std) {
                    if (val >= std.danger) { status = "HIGH"; col = "text-red-500"; }
                    else if (val >= std.normal) { status = "BORDER"; col = "text-amber-500"; }
                }

                grid.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest mb-1">${key}</p>
                        <p class="text-lg font-black text-slate-800">${val}</p>
                        <p class="text-[9px] font-black ${col}">${status}</p>
                    </div>
                `;
            });
            updateProfileHeader();
        }

        // --- Core Functions ---
        function handleDateChange(d) {
            state.currentDate = d;
            initCurrentDay(d);
            showMessage(`${d}ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹`);
        }

        function initCurrentDay(d) {
            if (!state.dailyData[d]) {
                state.dailyData[d] = {
                    water: 0, weight: '', bpH: '', bpL: '', morning: '', lunch: '', dinner: '', snack: state.profile.routineMeal || '',
                    wake: '', sleep: '', exercise: state.profile.routineEx || '', stool: '', isAuto: true
                };
            }
            loadDailyDataUI(d);
        }

        function saveDailyData() {
            const d = state.dailyData[state.currentDate];
            d.water = parseInt(document.getElementById('input-water').value) || 0;
            d.weight = document.getElementById('input-weight').value;
            d.bpH = document.getElementById('input-bp-high').value;
            d.bpL = document.getElementById('input-bp-low').value;
            d.morning = document.getElementById('meal-morning').value;
            d.lunch = document.getElementById('meal-lunch').value;
            d.dinner = document.getElementById('meal-dinner').value;
            d.snack = document.getElementById('meal-snack').value;
            d.wake = document.getElementById('input-wake').value;
            d.sleep = document.getElementById('input-sleep').value;
            d.exercise = document.getElementById('input-exercise').value;
            d.stool = document.getElementById('input-stool').value;
            d.isAuto = false;

            localStorage.setItem('ai_health_v4_data', JSON.stringify(state.dailyData));
            updateProfileHeader();
            showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ï¼ˆæ“¬ä¼¼ï¼‰ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function loadDailyDataUI(d) {
            const data = state.dailyData[d];
            if (!data) return;

            const elements = {
                'input-water': data.water || 0,
                'input-weight': data.weight || '',
                'input-bp-high': data.bpH || '',
                'input-bp-low': data.bpL || '',
                'meal-morning': data.morning || '',
                'meal-lunch': data.lunch || '',
                'meal-dinner': data.dinner || '',
                'meal-snack': data.snack || '',
                'input-wake': data.wake || '',
                'input-sleep': data.sleep || '',
                'input-exercise': data.exercise || '',
                'input-stool': data.stool || ''
            };

            for (const [id, value] of Object.entries(elements)) {
                const el = document.getElementById(id);
                if (el) {
                    el.value = value;
                }
            }

            updateWaterLabel(data.water || 0);
            updateProfileHeader();
        }

        // --- AI Insight Engine ---
        function runAnalysis() {
            const data = state.dailyData[state.currentDate];
            if (!data) return;

            const check = state.profile.checkup;
            const meals = (data.morning + "," + data.lunch + "," + data.dinner + "," + data.snack).toLowerCase();
            
            // 1. Nutrient Scoring
            let scores = { p: 0, c: 0, f: 0, v: 0, fi: 0, s: 0 };
            let mealCount = 0;
            Object.keys(FOOD_KNOWLEDGE).forEach(k => {
                if (meals.includes(k)) {
                    const n = FOOD_KNOWLEDGE[k];
                    scores.p += n.p; scores.c += n.c; scores.f += n.f; scores.v += n.v; scores.fi += n.fi; scores.s += n.s;
                    mealCount++;
                }
            });
            const div = mealCount > 0 ? Math.min(mealCount, 3) : 1;
            const finalScores = [scores.p/div, scores.c/div, scores.f/div, scores.v/div, scores.fi/div].map(v => Math.min(v, 10));
            
            if (state.chart) {
                state.chart.data.datasets[0].data = finalScores;
                state.chart.update();
            }

            // 2. Risk & Insight Building
            let reportHtml = "";
            let riskHtml = "";
            let suggestions = ["ã»ã†ã‚Œã‚“è‰", "ã‚µãƒ", "ç´è±†"];

            // Weight & BMI
            if (data.weight && state.profile.height) {
                const bmi = (data.weight / Math.pow(state.profile.height/100, 2)).toFixed(1);
                const isHeavy = bmi >= 25;
                riskHtml += createRiskItem("BMI", bmi, isHeavy ? 'è¦è­¦æˆ’' : 'æ­£å¸¸', isHeavy ? 'risk-high' : 'risk-low');
                if (isHeavy) reportHtml += `<div class='bg-white/5 p-4 rounded-2xl'><p class='font-bold text-white mb-1 tracking-tight'>ğŸ“Š è‚¥æº€åˆ¤å®š (æ ¹æ‹ : BMI ${bmi})</p><p class='text-xs opacity-70'>${MED_REF.standards.bmi.source}ã®åŸºæº–å€¤(25)ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚è„‚è³ªãŠã‚ˆã³ç³–è³ªä»£è¬ã¸ã®è² è·ãŒé«˜ã¾ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚</p></div>`;
            }

            // High Blood Pressure (Current or Past)
            const curBPH = parseInt(data.bpH) || check.params.bpHigh;
            if (curBPH) {
                const isDanger = curBPH >= MED_REF.standards.bpHigh.danger;
                riskHtml += createRiskItem("è¡€åœ§", curBPH, isDanger ? 'é«˜å€¤' : 'æ­£å¸¸', isDanger ? 'risk-high' : 'risk-low');
                if (isDanger) {
                    reportHtml += `<div class='bg-white/5 p-4 rounded-2xl'><p class='font-bold text-white mb-1 tracking-tight'>â¤ï¸ è¡€åœ§ãƒªã‚¹ã‚¯ (æ ¹æ‹ : ${curBPH}mmHg)</p><p class='text-xs opacity-70'>${MED_REF.standards.bpHigh.source}ã®å®¶åº­è¡€åœ§åŸºæº–ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚ä»Šæ—¥ã®é£Ÿäº‹æ¨å®šå¡©åˆ†é‡ã¯é«˜ã‚ã§ã™ã€‚æ¸›å¡©ãŒå¿…è¦ã§ã™ã€‚</p></div>`;
                    suggestions.push("ã‚¢ãƒœã‚«ãƒ‰", "ãƒãƒŠãƒŠ");
                }
            }

            // Detected Findings (Qualitative)
            const findingsGrid = document.getElementById('findings-grid');
            const findingsSection = document.getElementById('findings-section');
            if (check.findings && check.findings.length > 0) {
                if (findingsSection) findingsSection.classList.remove('hidden');
                if (findingsGrid) {
                    findingsGrid.innerHTML = '';
                    check.findings.forEach(f => {
                        findingsGrid.innerHTML += `
                            <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50 flex items-start gap-3">
                                <div class="mt-1 w-2 h-2 rounded-full ${f.severity === 'high' ? 'bg-red-500' : 'bg-amber-500'}"></div>
                                <div>
                                    <p class="text-sm font-bold text-slate-800">${f.words[0]}</p>
                                    <p class="text-[10px] text-slate-500 mt-1">${f.basis}</p>
                                    <p class="text-[10px] text-blue-600 font-bold mt-2">AIåŠ©è¨€: ${f.advice}</p>
                                </div>
                            </div>
                        `;
                        reportHtml += `<div class='bg-white/5 p-4 rounded-2xl'><p class='font-bold text-white mb-1 tracking-tight'>ğŸ” æ‰€è¦‹æ¤œå‡º: ${f.words[0]}</p><p class='text-xs opacity-70'>${f.advice} æ ¹æ‹ : ${f.basis}</p></div>`;
                    });
                }
            } else if (findingsSection) {
                findingsSection.classList.add('hidden');
            }

            // Defaults
            if (!reportHtml) reportHtml = "<p class='text-center opacity-50 py-8 italic'>é‡å¤§ãªãƒªã‚¹ã‚¯ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
            
            const reportEl = document.getElementById('ai-report-content');
            if (reportEl) reportEl.innerHTML = reportHtml;
            
            const riskEl = document.getElementById('health-risk-list');
            if (riskEl) riskEl.innerHTML = riskHtml || "<p class='text-xs opacity-40 italic'>No data available</p>";
            
            // Render Suggestions
            const suggestContainer = document.getElementById('suggested-foods');
            if (suggestContainer) {
                suggestContainer.innerHTML = [...new Set(suggestions)].map(s => `<span class="px-3 py-1 bg-indigo-50 text-indigo-600 text-[10px] rounded-full font-bold border border-indigo-100">${s}</span>`).join('');
            }
        }

        function createRiskItem(label, val, status, css) {
            return `
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter">${label}</span>
                    <div class="text-right">
                        <span class="font-black text-slate-800">${val}</span>
                        <span class="risk-pill ${css} ml-2">${status}</span>
                    </div>
                </div>
            `;
        }

        // --- Helper UIs ---
        function switchTab(id) {
            ['input', 'analysis', 'history', 'recipes', 'settings'].forEach(t => {
                const view = document.getElementById(`view-${t}`);
                const tab = document.getElementById(`tab-${t}`);
                if (view) view.classList.add('hidden');
                if (tab) {
                    tab.classList.remove('tab-active');
                    tab.classList.add('text-slate-400');
                }
            });
            const activeView = document.getElementById(`view-${id}`);
            const activeTab = document.getElementById(`tab-${id}`);
            if (activeView) activeView.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.add('tab-active');
                activeTab.classList.remove('text-slate-400');
            }
            if (id === 'analysis') runAnalysis();
            if (id === 'history') updateHistoryUI();
        }

        function initChart() {
            const el = document.getElementById('nutrientChart');
            if (!el) return;
            const ctx = el.getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['P (Protein)', 'C (Carb)', 'F (Fat)', 'V (Vitamin)', 'Fi (Fiber)'],
                    datasets: [{
                        label: 'ä»Šæ—¥',
                        data: [0,0,0,0,0],
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#3b82f6',
                        borderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 10, ticks: { display: false }, grid: { color: '#f1f5f9' }, angleLines: { color: '#f1f5f9' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function saveSettings(showMsg = true) {
            state.profile.name = document.getElementById('setting-name').value;
            state.profile.height = document.getElementById('setting-height').value;
            localStorage.setItem('ai_health_v4_prof', JSON.stringify(state.profile));
            if(showMsg) showMessage('è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            updateProfileHeader();
        }

        function loadProfileUI() {
            const nameEl = document.getElementById('setting-name');
            const heightEl = document.getElementById('setting-height');
            if (nameEl) nameEl.value = state.profile.name || '';
            if (heightEl) heightEl.value = state.profile.height || '';
            updateProfileHeader();
        }

        function updateProfileHeader() {
            const nameHeader = document.getElementById('header-user-name');
            if (nameHeader) nameHeader.textContent = state.profile.name;
            
            const w = state.dailyData[state.currentDate]?.weight;
            if (w && state.profile.height) {
                const bmi = (w / Math.pow(state.profile.height/100, 2)).toFixed(1);
                const bmiHeader = document.getElementById('header-bmi');
                if (bmiHeader) bmiHeader.textContent = `BMI: ${bmi}`;
                
                const indicator = document.getElementById('health-indicator');
                if (indicator) {
                    indicator.className = `absolute -bottom-1 -right-1 w-4 h-4 border-2 border-white rounded-full ${bmi >= 25 ? 'bg-red-500' : 'bg-emerald-500'}`;
                }
            }
            
            const check = state.profile.checkup;
            const statusLabel = document.getElementById('header-scan-status');
            if (statusLabel) {
                if (check && check.findings && check.findings.length > 0) {
                    statusLabel.textContent = "æ‰€è¦‹ã‚ã‚Š";
                    statusLabel.className = "text-[10px] font-bold px-2 py-0.5 bg-red-50 rounded text-red-600 tracking-wider";
                } else if (check && check.params && Object.keys(check.params).length > 0) {
                    statusLabel.textContent = "è§£ææ¸ˆã¿";
                    statusLabel.className = "text-[10px] font-bold px-2 py-0.5 bg-blue-50 rounded text-blue-600 tracking-wider";
                }
            }
        }

        function showMessage(t) {
            const b = document.getElementById('msg-box');
            if (!b) return;
            b.textContent = t;
            b.classList.remove('hidden');
            setTimeout(() => b.classList.add('hidden'), 3000);
        }

        // --- History & Recipes (Standard implementation) ---
        function updateHistoryUI() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const y = state.calendarViewDate.getFullYear(), m = state.calendarViewDate.getMonth();
            const title = document.getElementById('calendar-title');
            if (title) title.textContent = `${y}.${String(m + 1).padStart(2,'0')}`;
            
            const start = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<start; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=days; d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasData = state.dailyData[ds] && !state.dailyData[ds].isAuto;
                const active = ds === state.currentDate;
                const el = document.createElement('button');
                el.onclick = () => {
                    handleDateChange(ds);
                    const dp = document.getElementById('active-date-picker');
                    if (dp) dp.value = ds;
                    switchTab('input');
                };
                el.className = `calendar-day border rounded-2xl p-1 text-left flex flex-col justify-between hover:bg-white transition-all ${active ? 'today shadow-md' : 'border-slate-100'}`;
                el.innerHTML = `<span class="text-[10px] font-black ${active ? 'text-blue-600' : 'text-slate-300'}">${d}</span>${hasData ? '<div class="w-2 h-2 bg-blue-500 rounded-full mx-auto mb-1 shadow-sm"></div>' : ''}`;
                grid.appendChild(el);
            }
        }
        function prevMonth() { state.calendarViewDate.setMonth(state.calendarViewDate.getMonth()-1); updateHistoryUI(); }
        function nextMonth() { state.calendarViewDate.setMonth(state.calendarViewDate.getMonth()+1); updateHistoryUI(); }
        
        function searchHistory(q) {
            const r = document.getElementById('search-results');
            if (!r) return;
            r.innerHTML = '';
            if(!q) return;
            
            Object.entries(state.dailyData).forEach(([d, v]) => {
                const text = ((v.morning||"")+(v.lunch||"")+(v.dinner||"")+(v.snack||"")+(v.exercise||"")+(v.stool||"")).toLowerCase();
                if(text.includes(q.toLowerCase())) {
                    const i = document.createElement('div');
                    i.className = "p-4 bg-white border border-slate-100 rounded-2xl text-xs flex justify-between cursor-pointer hover:shadow-md transition-shadow";
                    i.onclick = () => { handleDateChange(d); switchTab('input'); };
                    i.innerHTML = `<div><p class="font-black text-slate-800">${d}</p><p class="text-slate-400 mt-1 truncate max-w-[120px]">${v.morning || 'è©³ç´°ã‚ã‚Š'}</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>`;
                    r.appendChild(i);
                    lucide.createIcons();
                }
            });
        }
        
        function updateRecipeUI() {
            const list = document.getElementById('recipe-list');
            if (!list) return;
            list.innerHTML = state.recipes.map(r => `
                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative group">
                    <p class="font-bold text-slate-800">${r.name}</p><p class="text-[10px] text-slate-400 mt-2">${r.items}</p>
                    <button onclick="deleteRecipe(${r.id})" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }
        function saveRecipe() {
            const n = document.getElementById('recipe-name').value, i = document.getElementById('recipe-items').value;
            if(!n || !i) return; state.recipes.push({ id: Date.now(), name: n, items: i });
            localStorage.setItem('ai_health_v4_recipes', JSON.stringify(state.recipes));
            updateRecipeUI(); document.getElementById('recipe-name').value = ''; document.getElementById('recipe-items').value = '';
            showMessage('ãƒ¬ã‚·ãƒ”ã‚’ãƒã‚¤ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã—ã¾ã—ãŸ');
        }
        function deleteRecipe(id) {
            state.recipes = state.recipes.filter(r => r.id !== id);
            localStorage.setItem('ai_health_v4_recipes', JSON.stringify(state.recipes));
            updateRecipeUI();
        }
        function openRecipePicker() {
            const l = document.getElementById('picker-list');
            if (!l) return;
            l.innerHTML = state.recipes.map(r => `
                <button onclick="appendRecipe('${r.items}')" class="w-full text-left p-5 bg-slate-50 border border-slate-100 rounded-3xl hover:bg-blue-50 hover:border-blue-200 transition-all">
                    <p class="font-bold text-slate-800 text-sm">${r.name}</p><p class="text-[10px] text-slate-400 mt-2">${r.items}</p>
                </button>
            `).join('') || '<p class="text-xs text-center py-10 text-slate-400 font-bold uppercase tracking-widest">No recipes found</p>';
            const modal = document.getElementById('recipe-picker-modal');
            if (modal) modal.classList.replace('hidden', 'flex');
        }
        function closeRecipePicker() {
            const modal = document.getElementById('recipe-picker-modal');
            if (modal) modal.classList.replace('flex', 'hidden');
        }
        function appendRecipe(it) {
            const el = document.getElementById('meal-dinner');
            if (!el) return;
            const c = el.value;
            el.value = c ? c + ", " + it : it;
            closeRecipePicker();
            showMessage('å¤•é£Ÿã«è¿½åŠ ã—ã¾ã—ãŸ');
        }
        function updateWaterLabel(v) {
            const el = document.getElementById('water-val');
            if (el) el.innerHTML = `${v} <span class="text-xs text-slate-400 font-normal">ml</span>`;
        }
    </script>
</body>
</html>